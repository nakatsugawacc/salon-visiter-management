import{w as u}from"./BSneUk9q.js";const k=u([{id:1,name:"受付",order:1,color:"bg-blue-100"},{id:2,name:"施術部屋A",order:2,color:"bg-purple-100"},{id:3,name:"施術部屋B",order:3,color:"bg-pink-100"},{id:4,name:"施術部屋C",order:4,color:"bg-indigo-100"},{id:5,name:"完了",order:5,color:"bg-gray-100"}]),a=[{id:1,name:"山田 太郎",phone:"090-1234-5678",currentCheckpointId:1,arrivedAt:new Date().toISOString(),status:"未来店",detailedStatus:"未来店",assignedRoom:null,qrToken:"visitor-1-token",qrScannedAt:null,history:[]},{id:2,name:"佐藤 花子",phone:"090-2345-6789",currentCheckpointId:1,arrivedAt:new Date(Date.now()-15*6e4).toISOString(),status:"未来店",detailedStatus:"未来店",assignedRoom:null,qrToken:"visitor-2-token",qrScannedAt:null,history:[]},{id:3,name:"鈴木 一郎",phone:"090-3456-7890",currentCheckpointId:1,arrivedAt:new Date(Date.now()-8*6e4).toISOString(),status:"未来店",detailedStatus:"未来店",assignedRoom:null,qrToken:"visitor-3-token",qrScannedAt:null,history:[]},{id:4,name:"田中 美咲",phone:"090-4567-8901",currentCheckpointId:1,arrivedAt:new Date(Date.now()-25*6e4).toISOString(),status:"未来店",detailedStatus:"未来店",assignedRoom:null,qrToken:"visitor-4-token",qrScannedAt:null,history:[]}],v={"visitor-1-token":1,"visitor-2-token":2,"visitor-3-token":3,"visitor-4-token":4};function S(l){return{1:"受付",2:"施術部屋A",3:"施術部屋B",4:"施術部屋C",5:"完了"}[l]||"不明"}function h(){const{subscribe:l,set:n,update:s}=u(a);{const r=localStorage.getItem("visitors");if(r)try{const t=JSON.parse(r);t.some(o=>!o.qrToken)?(console.log("古いデータ構造を検出。初期データで上書きします。"),n(a),localStorage.setItem("visitors",JSON.stringify(a))):n(t)}catch(t){console.error("Failed to parse stored visitors",t),n(a),localStorage.setItem("visitors",JSON.stringify(a))}else localStorage.setItem("visitors",JSON.stringify(a));let e=a;window.addEventListener("storage",t=>{if(t.key==="visitors"&&t.newValue)try{const o=JSON.parse(t.newValue);n(o),o.forEach(i=>{const c=e.find(d=>d.id===i.id);if(c&&c.detailedStatus!==i.detailedStatus){const d=S(i.currentCheckpointId);p.add({visitorName:i.name,checkpointName:d,status:i.detailedStatus,timestamp:new Date().toISOString()})}}),e=o}catch(o){console.error("Failed to parse storage event",o)}})}return{subscribe:l,moveVisitor:(r,e)=>{s(t=>{const o=t.find(i=>i.id===r);return o&&(o.currentCheckpointId=e,o.arrivedAt=new Date().toISOString(),o.status="来店中",o.history=o.history||[],o.history.push({checkpointId:e,timestamp:new Date().toISOString()})),localStorage.setItem("visitors",JSON.stringify(t)),t})},updateStatus:(r,e,t=null)=>{s(o=>{const i=o.find(c=>c.id===r);if(i){const c=i.detailedStatus;if(i.detailedStatus=e,i.status="来店中",e==="受付"&&!i.qrScannedAt&&(i.qrScannedAt=new Date().toISOString()),t&&!i.assignedRoom){i.assignedRoom=t;const d=t==="A"?2:t==="B"?3:4;i.currentCheckpointId=d}if(e==="完了"&&(i.status="完了",i.currentCheckpointId=5),i.history=i.history||[],i.history.push({status:e,timestamp:new Date().toISOString()}),c!==e){const d=S(i.currentCheckpointId),g=e==="着替え前完了"?"ready":e==="退出準備中"?"treatment_complete":"checkin";p.add({visitorName:i.name,checkpointName:d,status:e,type:g,timestamp:new Date().toISOString()})}}return localStorage.setItem("visitors",JSON.stringify(o)),o})},markReady:r=>{s(e=>{const t=e.find(o=>o.id===r);return t&&(t.isReady=!0,t.history=t.history||[],t.history.push({action:"ready",timestamp:new Date().toISOString()})),localStorage.setItem("visitors",JSON.stringify(e)),e})},markTreatmentComplete:r=>{s(e=>{const t=e.find(o=>o.id===r);return t&&(t.isTreatmentComplete=!0,t.history=t.history||[],t.history.push({action:"treatment_complete",timestamp:new Date().toISOString()})),localStorage.setItem("visitors",JSON.stringify(e)),e})},reset:()=>{n(a),m.set(null),localStorage.setItem("visitors",JSON.stringify(a))}}}const I=h(),m=u(null);function y(){const{subscribe:l,update:n}=u([]);return{subscribe:l,add:s=>{const r=Date.now(),e={...s,id:r};n(t=>[...t,e]),m.set(e),setTimeout(()=>{n(t=>t.filter(o=>o.id!==r))},5e3)},addReady:s=>{const r=Date.now(),e={...s,id:r,type:"ready"};n(t=>[...t,e]),m.set(e),setTimeout(()=>{n(t=>t.filter(o=>o.id!==r))},5e3)},addTreatmentComplete:s=>{const r=Date.now(),e={...s,id:r,type:"treatment_complete"};n(t=>[...t,e]),m.set(e),setTimeout(()=>{n(t=>t.filter(o=>o.id!==r))},5e3)},remove:s=>{n(r=>r.filter(e=>e.id!==s))}}}const p=y();export{I as a,k as c,m as l,p as n,v};
