import{w as l}from"./XRPCmplD.js";const k=l([{id:1,name:"受付",order:1,color:"bg-blue-100"},{id:2,name:"施術部屋A",order:2,color:"bg-purple-100"},{id:3,name:"施術部屋B",order:3,color:"bg-pink-100"},{id:4,name:"施術部屋C",order:4,color:"bg-indigo-100"},{id:5,name:"完了",order:5,color:"bg-gray-100"}]),a=[{id:1,name:"山田 太郎",phone:"090-1234-5678",currentCheckpointId:1,arrivedAt:new Date().toISOString(),status:"未来店",detailedStatus:"未来店",assignedRoom:null,qrToken:"visitor-1-token",qrScannedAt:null,history:[]},{id:2,name:"佐藤 花子",phone:"090-2345-6789",currentCheckpointId:1,arrivedAt:new Date(Date.now()-15*6e4).toISOString(),status:"未来店",detailedStatus:"未来店",assignedRoom:null,qrToken:"visitor-2-token",qrScannedAt:null,history:[]},{id:3,name:"鈴木 一郎",phone:"090-3456-7890",currentCheckpointId:1,arrivedAt:new Date(Date.now()-8*6e4).toISOString(),status:"未来店",detailedStatus:"未来店",assignedRoom:null,qrToken:"visitor-3-token",qrScannedAt:null,history:[]},{id:4,name:"田中 美咲",phone:"090-4567-8901",currentCheckpointId:1,arrivedAt:new Date(Date.now()-25*6e4).toISOString(),status:"未来店",detailedStatus:"未来店",assignedRoom:null,qrToken:"visitor-4-token",qrScannedAt:null,history:[]}],v={"visitor-1-token":1,"visitor-2-token":2,"visitor-3-token":3,"visitor-4-token":4};function p(c){return{1:"受付",2:"施術部屋A",3:"施術部屋B",4:"施術部屋C",5:"完了"}[c]||"不明"}function g(){const{subscribe:c,set:n,update:s}=l(a);{const i=localStorage.getItem("visitors");if(i)try{const t=JSON.parse(i);t.some(o=>!o.qrToken)?(console.log("古いデータ構造を検出。初期データで上書きします。"),n(a),localStorage.setItem("visitors",JSON.stringify(a))):n(t)}catch(t){console.error("Failed to parse stored visitors",t),n(a),localStorage.setItem("visitors",JSON.stringify(a))}else localStorage.setItem("visitors",JSON.stringify(a));let e=a;window.addEventListener("storage",t=>{if(t.key==="visitors"&&t.newValue)try{const o=JSON.parse(t.newValue);n(o),e=o}catch(o){console.error("Failed to parse storage event",o)}})}return{subscribe:c,moveVisitor:(i,e)=>{s(t=>{const o=t.find(r=>r.id===i);return o&&(o.currentCheckpointId=e,o.arrivedAt=new Date().toISOString(),o.status="来店中",o.history=o.history||[],o.history.push({checkpointId:e,timestamp:new Date().toISOString()})),localStorage.setItem("visitors",JSON.stringify(t)),t})},updateStatus:(i,e,t=null)=>{s(o=>{const r=o.find(m=>m.id===i);if(r){const m=r.detailedStatus;if(r.detailedStatus=e,r.status="来店中",e==="受付"&&!r.qrScannedAt&&(r.qrScannedAt=new Date().toISOString()),t&&!r.assignedRoom){r.assignedRoom=t;const u=t==="A"?2:t==="B"?3:4;r.currentCheckpointId=u}if(e==="完了"&&(r.status="完了",r.currentCheckpointId=5),r.history=r.history||[],r.history.push({status:e,timestamp:new Date().toISOString()}),m!==e){const u=p(r.currentCheckpointId),S=e==="着替え前完了"?"ready":e==="退出準備中"?"treatment_complete":"checkin";h.add({visitorName:r.name,checkpointName:u,status:e,type:S,timestamp:new Date().toISOString()})}}return localStorage.setItem("visitors",JSON.stringify(o)),o})},markReady:i=>{s(e=>{const t=e.find(o=>o.id===i);return t&&(t.isReady=!0,t.history=t.history||[],t.history.push({action:"ready",timestamp:new Date().toISOString()})),localStorage.setItem("visitors",JSON.stringify(e)),e})},markTreatmentComplete:i=>{s(e=>{const t=e.find(o=>o.id===i);return t&&(t.isTreatmentComplete=!0,t.history=t.history||[],t.history.push({action:"treatment_complete",timestamp:new Date().toISOString()})),localStorage.setItem("visitors",JSON.stringify(e)),e})},reset:()=>{n(a),d.set(null),localStorage.setItem("visitors",JSON.stringify(a))}}}const I=g(),d=l(null);function y(){const{subscribe:c,update:n}=l([]);return{subscribe:c,add:s=>{const i=Date.now(),e={...s,id:i};n(t=>[...t,e]),d.set(e),setTimeout(()=>{n(t=>t.filter(o=>o.id!==i))},5e3)},addReady:s=>{const i=Date.now(),e={...s,id:i,type:"ready"};n(t=>[...t,e]),d.set(e),setTimeout(()=>{n(t=>t.filter(o=>o.id!==i))},5e3)},addTreatmentComplete:s=>{const i=Date.now(),e={...s,id:i,type:"treatment_complete"};n(t=>[...t,e]),d.set(e),setTimeout(()=>{n(t=>t.filter(o=>o.id!==i))},5e3)},remove:s=>{n(i=>i.filter(e=>e.id!==s))}}}const h=y();export{I as a,k as c,d as l,h as n,v};
